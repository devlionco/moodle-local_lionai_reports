function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("local_lionai_reports/report",["exports","core/ajax","core/notification","core/templates","./spinneroverlay","./jquery.dataTables","core/modal_factory","core/modal_events","core/str","./codemirror"],(function(_exports,_ajax,_notification,_templates,_spinneroverlay,_jquery,_modal_factory,_modal_events,_str,CodeMirror){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates),_spinneroverlay=_interopRequireDefault(_spinneroverlay),_jquery=_interopRequireDefault(_jquery),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),CodeMirror=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(CodeMirror);var _ref2,_ref3,_ref4,dataTemp={report:null,table:null,sqlChanged:!1,sqlOriginal:"",editor:null},Selectors={elements:{mainelement:"lionai_reports-area",report:"lionai_reports-report",promptTextarea:"id_userprompt",querysqlid:"id_querysql",senduserpromptid:"id_senduserprompt",getresultid:"id_getresult",submitbutton:"id_submitbutton",trytofixid:"id_trytofix",errordivid:"id_error_querysql",lionaiReportshistory:"lionai_reportshistory",queryresultwrapperid:"id_queryresultwrapper",queryresultid:"id_queryresult",queryresultmessage:"id_queryresultmessage",thmbup:"thmbup",thmbdown:"thmbdown",ratebtnswrapper:"ratebtns-wrapper",previewwrapper:"previewwrapper"},targets:{}},getReport=function(id){return _ajax.default.call([{methodname:"local_lionai_reports_getreport",args:{id:id}}])[0]},updateReport=function(id){var action=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"update",data=arguments.length>2?arguments[2]:void 0;return _ajax.default.call([{methodname:"local_lionai_reports_updatereport",args:{id:id,action:action,data:JSON.stringify(data)}}])[0]},renderReport=function renderReport(){_templates.default.render("local_lionai_reports/report",dataTemp.report).then((function(html,js){_templates.default.replaceNodeContents(document.getElementById(Selectors.elements.mainelement),html,js),Selectors.targets.promptElem=document.getElementById(Selectors.elements.promptTextarea),Selectors.targets.querysqlElem=document.getElementById(Selectors.elements.querysqlid),Selectors.targets.trytofixlElem=document.getElementById(Selectors.elements.trytofixid),Selectors.targets.queryresultmessage=document.getElementById(Selectors.elements.queryresultmessage),Selectors.targets.thmbup=document.getElementById(Selectors.elements.thmbup),Selectors.targets.thmbdown=document.getElementById(Selectors.elements.thmbdown),Selectors.targets.ratebtnswrapper=document.getElementById(Selectors.elements.ratebtnswrapper),Selectors.targets.senduserpromptButton=document.getElementById(Selectors.elements.senduserpromptid),Selectors.targets.getresultButton=document.getElementById(Selectors.elements.getresultid),Selectors.targets.errorDiv=document.getElementById(Selectors.elements.errordivid),Selectors.targets.lionaiReportshistory=document.getElementById(Selectors.elements.lionai_reportshistory),dataTemp.editor=CodeMirror.fromTextArea(Selectors.targets.querysqlElem,{lineNumbers:!0,theme:"darcula"}),Selectors.targets.thmbup.onclick=function(e){return ratePrompt(e.currentTarget.dataset.promptid,e.currentTarget.dataset.rate,e.currentTarget)},Selectors.targets.thmbdown.onclick=function(e){return ratePrompt(e.currentTarget.dataset.promptid,e.currentTarget.dataset.rate,e.currentTarget)},Selectors.targets.senduserpromptButton.addEventListener("click",(function(){sendPrompt(Selectors.targets.promptElem.value)})),Selectors.targets.getresultButton.addEventListener("click",(function(){getResult(Selectors.targets.querysqlElem.value)})),Selectors.targets.trytofixlElem.addEventListener("click",(function(){var value="";value+="try to fix this sql:\n\n";var actualsql=Selectors.targets.querysqlElem.value;value+=actualsql+="\n\n";var textContent=Selectors.targets.queryresultmessage.textContent;sendPrompt(value+=textContent)})),Selectors.targets.querysqlElem.addEventListener("change",(function(){var actualsql=Selectors.targets.querysqlElem.value;dataTemp.sqlOriginal!=actualsql&&originalDataChanged()})),Selectors.targets.promptElem.addEventListener("keydown",(function(event){(event.ctrlKey||event.metaKey)&&"Enter"===event.key?sendPrompt(Selectors.targets.promptElem.value):hideElement(Selectors.targets.ratebtnswrapper)})),document.querySelectorAll(".lionai_reports-examples-list .dropdown-item").forEach((function(item){item.addEventListener("click",(function(event){event.preventDefault();var value=item.textContent.trim();setUserPrompt(value),sendPrompt(value)}))})),_spinneroverlay.default.hidespinneroverlay(),hideElement(Selectors.targets.queryresultmessage),hideElement(Selectors.targets.trytofixlElem),hideElement(Selectors.targets.ratebtnswrapper),document.getElementById("edit-name-button").addEventListener("click",(function(){document.getElementById("edit-name-button").classList.add("d-none");var _ref,currentName=document.getElementById("edit-name").textContent,inputField=document.createElement("input");inputField.type="text",inputField.value=currentName,inputField.classList.add("w-100"),document.getElementById("edit-name").textContent="",document.getElementById("edit-name").appendChild(inputField),inputField.addEventListener("keydown",(_ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(event){var newName,response;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if("Enter"!==event.key){_context.next=13;break}return newName=inputField.value,document.getElementById("edit-name").textContent=newName,document.getElementById("edit-name-button").classList.remove("d-none"),_context.next=6,updateReport(dataTemp.report.id,"update",{name:newName});case 6:if(!_context.sent){_context.next=13;break}return _context.next=10,getReport(dataTemp.report.id);case 10:response=_context.sent,dataTemp.report=JSON.parse(response.data).report,renderReport();case 13:case"end":return _context.stop()}}),_callee)}))),function(_x){return _ref.apply(this,arguments)})),inputField.focus()})),document.getElementById("lionai_reportshistory").onclick=function(){showModal()}})).catch((function(error){return _notification.default.displayException(error)}))},setPreviewMessage=(_ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(count){var previewWrapper,previewTitle,previewTotal,previewNote1,previewNote2,previewMessageHtml;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return document.getElementById(Selectors.elements.previewwrapper).innerHTML="",previewWrapper=document.getElementById(Selectors.elements.previewwrapper),_context2.next=4,(0,_str.get_string)("preview","local_lionai_reports");case 4:return previewTitle=_context2.sent,_context2.next=7,(0,_str.get_string)("previewtotal","local_lionai_reports",count);case 7:return previewTotal=_context2.sent,_context2.next=10,(0,_str.get_string)("previewnote1","local_lionai_reports");case 10:return previewNote1=_context2.sent,_context2.next=13,(0,_str.get_string)("previewnote2","local_lionai_reports");case 13:previewNote2=_context2.sent,previewMessageHtml=(previewMessageHtml=(previewMessageHtml=(previewMessageHtml="<h2>"+previewTitle+"</h2><br>")+'<span class="font-weight-bold">'+previewTotal+"</span><br>")+"<span>"+previewNote1+"</span><br>")+'<span class="text-muted">'+previewNote2+"</span>",previewWrapper.innerHTML=previewMessageHtml;case 19:case"end":return _context2.stop()}}),_callee2)}))),function(_x2){return _ref2.apply(this,arguments)}),showModal=(_ref3=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(){var modal;return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return _context3.next=2,_modal_factory.default.create({title:(0,_str.get_string)("pickfromhistory","local_lionai_reports"),large:!0,body:_templates.default.render("local_lionai_reports/historymodal",dataTemp.report),footer:"An example footer content"});case 2:(modal=_context3.sent).show(),Selectors.targets.createdModal=modal,modal.getRoot().on(_modal_events.default.bodyRendered,(function(){var textarea=modal.getRoot()[0].querySelectorAll("textarea");textarea.length>0&&textarea.forEach((function(el){el.textLength>0&&CodeMirror.fromTextArea(el,{lineNumbers:!0,theme:"darcula"})})),renderHistory()}));case 6:case"end":return _context3.stop()}}),_callee3)}))),function(){return _ref3.apply(this,arguments)}),hideElement=function(target){target.classList.add("d-none")},showElement=function(target){target.classList.remove("d-none")},getResult=function(query){hideElement(Selectors.targets.queryresultmessage),hideElement(Selectors.targets.trytofixlElem),_ajax.default.call([{methodname:"local_lionai_reports_getresult",args:{query:query,id:dataTemp.report.id},done:function(data){var result=data.result,message=data.message,count=data.count;data=JSON.parse(data.data),setMessage(message,!result),setPreviewMessage(count),function(data){var keys=Object.keys(data);if((dataTemp.table||dataTemp.table&&0==keys.length)&&(dataTemp.table="",document.getElementById(Selectors.elements.queryresultid).innerHTML=""),document.getElementById(Selectors.elements.queryresultwrapperid).innerHTML="",document.getElementById(Selectors.elements.queryresultwrapperid).innerHTML='<table class="display w-100" id="id_queryresult"></table>',keys.length>0){var firstItem=data[keys[0]],columns=Object.keys(firstItem).map((function(key){return{title:key,data:key}})),dataArray=keys.map((function(key){return data[key]}));dataTemp.table=new _jquery.default("#".concat(Selectors.elements.queryresultid),{columns:columns,data:dataArray,scrollX:!0,autoWidth:!0})}}(data)},fail:function(error){_notification.default.exception(error)}}])},setTargetText=function(newText){!function(sql){Selectors.targets.querysqlElem.value=sql,dataTemp.editor&&(dataTemp.editor.toTextArea(),dataTemp.editor=null);var sqlEditors=Selectors.targets.querysqlElem.parentElement.querySelectorAll(".cm-editor");sqlEditors.length>0&&sqlEditors.forEach((function(el){el.remove()})),dataTemp.editor=CodeMirror.fromTextArea(Selectors.targets.querysqlElem,{lineNumbers:!0,theme:"darcula"}),getResult(sql)}(newText),_spinneroverlay.default.hidespinneroverlay(["id_userprompt","id_querysql","id_senduserprompt"])},setMessage=function(value){var correct=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;value.length>0&&(document.getElementById(Selectors.elements.queryresultmessage).innerHTML=value,showElement(Selectors.targets.queryresultmessage)),1==correct&&showElement(Selectors.targets.trytofixlElem)},originalDataChanged=function(){dataTemp.sqlChanged||(dataTemp.sqlChanged=!0,hideElement(Selectors.targets.ratebtnswrapper))},sendPrompt=function(prompt){_spinneroverlay.default.showspinneroverlay(["id_userprompt","id_querysql","id_senduserprompt"]),hideElement(Selectors.targets.queryresultmessage),hideElement(Selectors.targets.trytofixlElem),hideElement(Selectors.targets.ratebtnswrapper),_ajax.default.call([{methodname:"local_lionai_reports_send_prompt",args:{reportid:dataTemp.report.id,prompt:prompt,engine:dataTemp.report.engine,conversationid:dataTemp.report.conversationid},done:function(data){var message=data.message,correct=data.correct;if(2!=correct){setMessage("Does not look like correct code. Use carefully.",correct),_spinneroverlay.default.hidespinneroverlay(["id_userprompt","id_querysql","id_senduserprompt"]),Selectors.targets.querysqlElem.value=message,dataTemp.editor&&(dataTemp.editor.toTextArea(),dataTemp.editor=null);var sqlEditors=Selectors.targets.querysqlElem.parentElement.querySelectorAll(".cm-editor");return sqlEditors.length>0&&sqlEditors.forEach((function(el){el.remove()})),void(dataTemp.editor=CodeMirror.fromTextArea(Selectors.targets.querysqlElem,{lineNumbers:!0,theme:"darcula"}))}dataTemp.sqlOriginal=message,dataTemp.sqlChanged=!1,clearRateBtnsActiveClass(),showElement(Selectors.targets.ratebtnswrapper);var actionbuttons=document.getElementsByClassName("action-btns")[0];actionbuttons.classList.remove("d-none"),actionbuttons.classList.add("d-flex"),setPromptidToBtns(data.promptid),setTargetText(message)},fail:function(error){_notification.default.exception(error),_spinneroverlay.default.hidespinneroverlay(["id_userprompt","id_querysql","id_senduserprompt"])}}])},setUserPrompt=function(value){Selectors.targets.promptElem.value=value},renderHistory=function(){document.querySelectorAll(".lionai_reports-history-list-item").forEach((function(item){item.addEventListener("click",(function(event){event.preventDefault();var value=item.textContent.trim(),role=item.getAttribute("data-role");Selectors.targets.createdModal.destroy(),"user"==role?(setUserPrompt(value),sendPrompt(value)):setTargetText(value)}))}))},ratePrompt=function(promptid,rate,target){rate=target.classList.contains("active")?0:rate,_ajax.default.call([{methodname:"local_lionai_reports_rate_prompt",args:{promptid:+promptid,rate:+rate},done:function(){return clearRateBtnsActiveClass(),0===rate?target.classList.remove("active"):target.classList.add("active")},fail:function(error){_notification.default.exception(error)}}])},setPromptidToBtns=function(promptid){Selectors.targets.thmbup.dataset.promptid=promptid,Selectors.targets.thmbdown.dataset.promptid=promptid},clearRateBtnsActiveClass=function(){Selectors.targets.thmbup.classList.remove("active"),Selectors.targets.thmbdown.classList.remove("active")},init=(_ref4=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(_reportid){var response;return regeneratorRuntime.wrap((function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return _context4.next=2,getReport(_reportid);case 2:response=_context4.sent,dataTemp.report=JSON.parse(response.data).report,renderReport();case 5:case"end":return _context4.stop()}}),_callee4)}))),function(_x3){return _ref4.apply(this,arguments)});_exports.init=init}));

//# sourceMappingURL=report.min.js.map