define("local_smartreport/report",["exports","core/ajax","jquery","core/notification","core/toast","core/templates","./spinneroverlay","https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"],(function(_exports,_ajax,_jquery,_notification,_toast,_templates,_spinneroverlay,_jqueryDataTablesMin){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Connect smartreport functionality.
   *
   * @module      local_smartreport/report
   * @author      Anton P. <anton@devlion.co>
   * @copyright   2023 Devlion <info@devlion.co>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */let report,table;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_jquery=_interopRequireDefault(_jquery),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates),_spinneroverlay=_interopRequireDefault(_spinneroverlay);const SELECTORS_MAINELEMENT="smartreport-area",SELECTORS_promptid="id_userprompt",SELECTORS_querysqlid="id_querysql",SELECTORS_senduserpromptid="id_senduserprompt",SELECTORS_trytofixid="id_trytofix",SELECTORS_errordivid="id_error_querysql",SELECTORS_smartreporthistory="smartreporthistory",SELECTORS_queryresultwrapperid="id_queryresultwrapper",SELECTORS_queryresultid="id_queryresult",SELECTORS_queryresultmessage="id_queryresultmessage",renderReport=_report=>{console.log(_report),_report.allreportsurl=M.cfg.wwwroot+"/local/smartreport",_templates.default.render("local_smartreport/report",_report).then((function(html,js){_templates.default.appendNodeContents(document.getElementById(SELECTORS_MAINELEMENT),html,js);const promptElem=document.getElementById(SELECTORS_promptid),querysqlElem=document.getElementById(SELECTORS_querysqlid),trytofixlElem=document.getElementById(SELECTORS_trytofixid),senduserpromptButton=(document.getElementById(SELECTORS_queryresultmessage),document.getElementById(SELECTORS_senduserpromptid)),errorDiv=document.getElementById(SELECTORS_errordivid);document.getElementById(SELECTORS_smartreporthistory);let cm;const setSql=sql=>{querysqlElem.value=sql,getResult(sql)},setUserPrompt=value=>{promptElem.value=value};let setTargetText=function(newText){setSql(newText),_spinneroverlay.default.hidespinneroverlay(["id_userprompt","id_querysql","id_senduserprompt"])};const setMessage=value=>{(0,_jquery.default)("#"+SELECTORS_queryresultmessage).html(value)};let sendPrompt=prompt=>{_spinneroverlay.default.showspinneroverlay(["id_userprompt","id_querysql","id_senduserprompt"]),console.log("prompt",prompt),console.log("report",report),_ajax.default.call([{methodname:"local_smartreport_send_prompt",args:{reportid:report.id,prompt:prompt,engine:report.engine,conversationid:report.conversationid},done:function(data){let message=data.message,correct=data.correct;console.log(data);let autoSave=!0;setMessage(""),correct||(setMessage("Does not look like correct code. Use carefully."),autoSave=!1),setTargetText(message,autoSave)},fail:function(error){_notification.default.exception(error),_spinneroverlay.default.hidespinneroverlay(["id_userprompt","id_querysql","id_senduserprompt"])}}])},getResult=query=>{_ajax.default.call([{methodname:"local_smartreport_getresult",args:{query:query},done:function(data){console.log(data);let result=data.result,message=data.message;data=JSON.parse(data.data),console.log(data),setMessage(""),result||setMessage(message),(data=>{console.log(data);const keys=Object.keys(data);if((table||table&&0==keys.length)&&(table.destroy(),(0,_jquery.default)("#id_queryresult").html("")),(0,_jquery.default)("#"+SELECTORS_queryresultwrapperid).html(""),(0,_jquery.default)("#"+SELECTORS_queryresultwrapperid).html('<table class="display" id="id_queryresult"></table>'),keys.length>0){const firstItem=data[keys[0]],columns=Object.keys(firstItem).map((key=>({title:key,data:key}))),dataArray=keys.map((key=>data[key]));table=(0,_jquery.default)("#"+SELECTORS_queryresultid).DataTable({columns:columns,data:dataArray})}})(data)},fail:function(error){_notification.default.exception(error)}}])};let timeoutId;senduserpromptButton.addEventListener("click",(event=>{console.log(promptElem.value),sendPrompt(promptElem.value)})),trytofixlElem&&trytofixlElem.addEventListener("click",(event=>{console.log(promptElem.value);let value="";value+="try to fix this sql:\n\n";let nextSibling=querysqlElem.nextElementSibling;for(;nextSibling;){if(nextSibling.classList.contains("CodeMirror")){cm=nextSibling.CodeMirror;break}nextSibling=nextSibling.nextElementSibling}let actualsql=cm.getValue();actualsql+="\n\n",value+=actualsql;const codeElement=errorDiv.querySelector("code pre");if(codeElement){const textContent=codeElement.textContent;console.log(textContent),value+=textContent}sendPrompt(value)})),promptElem.addEventListener("keydown",(function(event){(event.ctrlKey||event.metaKey)&&"Enter"===event.key&&(console.log(promptElem.value),sendPrompt(promptElem.value))}));querysqlElem.addEventListener("input",(event=>{clearTimeout(timeoutId);const inputValue=querysqlElem.value;timeoutId=setTimeout((()=>{getResult(inputValue)}),500)}));document.querySelectorAll(".smartreport-examples-list .dropdown-item").forEach((item=>{item.addEventListener("click",(event=>{event.preventDefault();let value=item.textContent.trim();console.log(value),setUserPrompt(value),sendPrompt(value)}))})),document.querySelectorAll(".smartreport-history-list-item").forEach((item=>{item.addEventListener("click",(event=>{event.preventDefault();const value=item.textContent.trim(),role=item.getAttribute("data-role");console.log("Value: ".concat(value,", Role: ").concat(role)),(0,_jquery.default)("#historyModal").modal("hide"),"user"==role?setUserPrompt(value):setTargetText(value,!0)}))})),_spinneroverlay.default.hidespinneroverlay()})).catch()};_exports.init=async _reportid=>{console.log("init"),console.log("reportid",_reportid);const response=await(id=_reportid,_ajax.default.call([{methodname:"local_smartreport_getreport",args:{id:id}}])[0]);var id;report=JSON.parse(response.data).report,renderReport(report)}}));

//# sourceMappingURL=report.min.js.map